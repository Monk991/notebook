## 游戏服务器

* game-frame-nano/internal/game/manager_user.go

```go
package game

import (
	"log/slog"

	"gitee.com/monk99/game-frame-nano/protocol"
	"github.com/lonng/nano"
	"github.com/lonng/nano/component"
	"github.com/lonng/nano/session"
)

const kickResetBacklog = 8

var userManager = NewManagerUser()

type (
	ManagerUser struct {
		component.Base
		group      *nano.Group       // 广播channel
		players    map[int64]*Player // 所有的玩家
		chKick     chan int64        // 退出队列
		chReset    chan int64        // 重置队列
		chRecharge chan RechargeInfo // 充值信息
	}

	RechargeInfo struct {
		Uid  int64 // 用户ID
		Coin int64 // 房卡数量
	}
)

func NewManagerUser() *ManagerUser {
	return &ManagerUser{
		group:      nano.NewGroup("_SYSTEM_MESSAGE_BROADCAST"),
		players:    map[int64]*Player{},
		chKick:     make(chan int64, kickResetBacklog),
		chReset:    make(chan int64, kickResetBacklog),
		chRecharge: make(chan RechargeInfo, 32),
	}
}
 
func (m *ManagerUser) Login(s *session.Session, req *protocol.LoginToGameServerRequest) error {
	uid := req.Uid

	slog.Info("玩家登录", "UID", uid, "Req", req)

	return s.Response("ok")
}

```

- game-frame-nano/internal/game/game.go

```go
package game

import (
	"fmt"
	"log/slog"
	"net/http"
	"strings"

	"github.com/lonng/nano"
	"github.com/lonng/nano/component"
	"github.com/lonng/nano/pipeline"
	"github.com/lonng/nano/serialize/json"
	"github.com/lonng/nano/session"
	"github.com/spf13/viper"
)

const (
	minHeartbeatInterval = 5     // 最小心跳间隔(秒)
	defaultPort          = 12345 // 默认端口(如果需要)
)

func Startup() {
	comps := &component.Components{}
	comps.Register(
		userManager,
		component.WithName("user"),
		component.WithNameFunc(strings.ToLower),
	)
    // 通信甬道
	var stats = &stats{}
	pip := pipeline.New()
	pip.Outbound().PushBack(stats.outbound)
	pip.Inbound().PushBack(stats.inbound)

	addr := fmt.Sprintf(":%d", viper.GetInt("game-server.port"))

    // WebSocket
	nano.Listen(addr,
		nano.WithIsWebsocket(true),
		nano.WithPipeline(pip),
		// 	nano.WithHeartbeatInterval(time.Duration(heartbeat)*time.Second),
		nano.WithCheckOriginFunc(func(_ *http.Request) bool { return true }),
		nano.WithWSPath("/ws"),
		nano.WithDebugMode(),
		nano.WithSerializer(json.NewSerializer()), // override default serializer
		nano.WithComponents(comps),
	)

}

type (
	stats struct {
		outboundBytes int
		inboundBytes  int
	}
)

func (stats *stats) outbound(s *session.Session, msg *pipeline.Message) error {
	stats.outboundBytes += len(msg.Data)
	return nil
}

func (stats *stats) inbound(s *session.Session, msg *pipeline.Message) error {
	stats.inboundBytes += len(msg.Data)
	return nil
}

```
